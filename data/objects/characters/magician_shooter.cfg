# magician_shooter.cfg
# One of Smoke's mirrors; shoots at player
#
# Notes: With the current, 10x10 hurtbox, there are 10 units from
# one edge of a wall to another in the x and y directions.
# (If the walls have a single tile between them.)

#TODO:
# (Red) Cause flash upon attacking; delay attack slightly
# (Red) Give death animation

{

#DEFINES#
id: "magician_shooter",
prototype: ["magician_mirror"],
vehicle: false,
feet_width: null,
hitpoints: 8,
max_hitpoints: 8,
mass: 5,
object_level_collisions: true,

zorder: "@include data/zorder.cfg:player",

properties: {
	normal_alpha: 200,
},	#### EVENTS START HERE ####

on_create: "proto_event('magician_mirror','on_create')",

# -- Animations Logic -- #
on_process: "[
	if(is_walking, fire_event('process_walk')),
	if(abs(midpoint_x - old_midpoint_x) >= 32 or
	   abs(midpoint_y - old_midpoint_y) >= 32, [
		set(old_midpoint_x, midpoint_x),
		set(old_midpoint_y, midpoint_y),
		set(cycle_of_last_action, cycle),
		if(facing_up or facing_down, align_self_x),		
		if(facing_left or facing_right, align_self_y),
		if(is_player_visible or is_on_lens,
			if(is_lined_up_to_attack and not is_attack_on_cooldown,
				begin_attack,
				[set(cycle_of_last_sight, cycle), track_player]),
			if(is_player_found, track_player, new_dir)	// Do this if we cannot see player
			)
		] // We should be walking via animation
	)]",

on_collide_object_body: "[any_new_dir, debug(cycle)]",
on_collide_level: "debug('hi')",

on_end_look_down_anim: "animation('walk_down')",
on_end_look_up_anim: "animation('walk_up')",
on_end_look_right_anim: "animation('walk_right')",
on_end_look_left_anim: "animation('walk_left')",

	// Keep us from getting stuck
on_process_walk: "if(cycle - cycle_of_last_action > 30,
	[align_self, any_new_dir, set(cycle_of_last_action, cycle)])",

on_process_walk_up: "add(y, -movespeed)",
on_process_walk_down: "add(y, movespeed)",
on_process_walk_right: "add(x, movespeed)",
on_process_walk_left: "add(x, -movespeed)",

on_end_walk_up_anim: "animation('walk_up')",
on_end_walk_down_anim: "animation('walk_down')",
on_end_walk_right_anim: "animation('walk_right')",
on_end_walk_left_anim: "animation('walk_left')",

on_attack: "[
	animation('cast_'+dir_to_player),
	schedule(10, [
		spawn('magician_shooter.firebolt', midpoint_x, midpoint_y, facing,
			[set(child.velocity_x, launch_x(velocity)),
			set(child.velocity_y, launch_y(velocity))])
				where velocity = 450,
		set(cycle_of_last_attack, cycle)])
	]",

on_end_cast_down_anim: "animation('look_down')",
on_end_cast_up_anim: "animation('look_up')",
on_end_cast_right_anim: "animation('look_right')",
on_end_cast_left_anim: "animation('look_left')",

# -- Info and Time Attack -- #
			
#ANIMATIONS#
animation: [

	# -- Walking and Looking -- #
	{
		id: "look_down",
		body_area: "all",
		image: "characters/magician_yellow.png",
		rect: [90, 3, 115, 27],
		solid_area: [7,14,17,24],
		frames: 1,
		frames_per_row: 8,
		pad: 3,
		duration: 6,
	},

	{
		id: "look_up",
		body_area: "all",
		image: "characters/magician_yellow.png",
		rect: [208, 3, 233, 28],
		solid_area: [7,14,17,24],
		frames: 1,
		pad: 3,
		frames_per_row: 4,
		duration: 8,
	},
	
	{
		id: "look_right",
		body_area: "all",
		image: "characters/magician_yellow.png",
		rect: [90, 34, 115, 59],
		solid_area: [6,14,16,24],
		frames: 1,
		pad: 3,
		frames_per_row: 4,
		duration: 8,
	},

	{
		id: "look_left",
		body_area: "all",
		image: "characters/magician_yellow.png",
		rect: [150, 34, 175, 59],
		solid_area: [9,14,19,24],
		frames: 1,
		pad: 3,
		frames_per_row: 4,
		duration: 8,
	},
	
	{
		id: "walk_down",
		body_area: "all",
		image: "characters/magician_yellow.png",
		rect: [3, 3, 28, 28],
		solid_area: [7,14,17,24],
		attack_area: [6,13,18,25],
		frames: 4,
		pad: 3,
		frames_per_row: 4,
		duration: 9,
	},
	
	{
		id: "walk_up",
		body_area: "all",
		image: "characters/magician_yellow.png",
		rect: [121, 3, 146, 28],
		solid_area: [7,14,17,24],
		attack_area: [6,13,18,25],
		frames: 4,
		pad: 3,
		frames_per_row: 4,
		duration: 9,
	},

	{
		id: "walk_right",
		body_area: "all",
		image: "characters/magician_yellow.png",
		rect: [3, 34, 28, 59],
		solid_area: [6,14,16,24],	
		attack_area: [5,13,17,25],
		frames: 4,
		pad: 3,
		frames_per_row: 4,
		duration: 9,
	},
	
	{
		id: "walk_left",
		body_area: "all",
		image: "characters/magician_yellow.png",
		rect: [121, 34, 146, 59],
		solid_area: [9,14,19,24],
		attack_area: [8,13,20,25],
		frames: 4,
		pad: 3,
		frames_per_row: 4,
		duration: 9,
	},

	# -- Magic Weilding -- #			
	{
		id: "cast_down",
		body_area: "all",
		image: "characters/magician_yellow.png",
		rect: [61, 65, 86, 90],
		solid_area: [7,14,17,24],
		frames: 1,
		pad: 3,
		frames_per_row: 3,
		duration: 30,
	},
	
	{
		id: "cast_up",
		body_area: "all",
		image: "characters/magician_yellow.png",
		rect: [150, 65, 175, 90],
		solid_area: [7,14,17,24],
		frames: 1,
		pad: 3,
		frames_per_row: 3,
		duration: 30,
	},
	
	{
		id: "cast_right",
		body_area: "all",
		image: "characters/magician_yellow.png",
		rect: [61, 94, 86, 119],
		solid_area: [6,14,16,24],
		frames: 1,
		pad: 3,
		frames_per_row: 3,
		duration: 30,
	},
	
	{
		id: "cast_left",
		body_area: "all",
		image: "characters/magician_yellow.png",
		rect: [150, 94, 175, 119],
		solid_area: [9,14,19,24],
		frames: 1,
		pad: 3,
		frames_per_row: 3,
		duration: 30,
	},
],

object_type: [
	{
	id: "firebolt",
	dies_on_inactive: true,
	timer_frequency: 450,
	object_level_collisions: true,
	solid_dimensions: ["player"],
	collide_dimensions: ["player"],
	prototype: ["shot"],
	properties: {
	        attack_damage: "1",
	        team: "'evil'",
	},

	on_end_normal_anim: "animation('normal')",
	on_process: "if((time_in_animation%7) = 0, spawn('mage_playable.firebolt_trail',midpoint_x,midpoint_y,{velocity_x:0,velocity_y:0}))",
	on_end_flash_anim: "die()",
	on_timer: "die()",

	animation:
		{
		id: "normal",
		image: "effects/magic_fire.png",
		attack_area: [0,0,11,11],
		pad: 3,
		rect: [2,2,10,10],
		frames: 4,
		frames_per_row: 4,
		duration: 5
	    },
	},


	{
	id: "firebolt_trail",
	ignore_collide: true,
	on_end_normal_anim: "die()",
    
	zorder: 50,
	dies_on_inactive: true,
	on_spawned: "animation('normal')",

	animation:
	    {
		id: "normal",
		image: "effects/magic_fire.png",
		pad: 3,
		rect: [2, 14, 6, 18],
		frames: 4,
		frames_per_row: 5,
		duration: 4,
		x_accel: 0,
		y_accel: 0
	    },
	}
],

}
